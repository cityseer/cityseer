<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Cityseer API Docs</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:300,400,500">
    <meta name="description" content="Computational tools for urban analysis">
    
    <link rel="preload" href="/cityseer/assets/css/0.styles.7973ef14.css" as="style"><link rel="preload" href="/cityseer/assets/js/app.9d063ece.js" as="script"><link rel="preload" href="/cityseer/assets/js/2.0e550b61.js" as="script"><link rel="preload" href="/cityseer/assets/js/6.5f7a5e8e.js" as="script"><link rel="preload" href="/cityseer/assets/js/13.4af07594.js" as="script"><link rel="prefetch" href="/cityseer/assets/js/10.dea527c1.js"><link rel="prefetch" href="/cityseer/assets/js/11.c92ef4ad.js"><link rel="prefetch" href="/cityseer/assets/js/12.34194bc1.js"><link rel="prefetch" href="/cityseer/assets/js/14.18dad8c7.js"><link rel="prefetch" href="/cityseer/assets/js/15.614e8e57.js"><link rel="prefetch" href="/cityseer/assets/js/16.49ede94d.js"><link rel="prefetch" href="/cityseer/assets/js/17.6a3be9c7.js"><link rel="prefetch" href="/cityseer/assets/js/18.269ea207.js"><link rel="prefetch" href="/cityseer/assets/js/19.661d4283.js"><link rel="prefetch" href="/cityseer/assets/js/20.6d941157.js"><link rel="prefetch" href="/cityseer/assets/js/3.217a8fb7.js"><link rel="prefetch" href="/cityseer/assets/js/4.b2e0bfbd.js"><link rel="prefetch" href="/cityseer/assets/js/5.f4ee4c69.js"><link rel="prefetch" href="/cityseer/assets/js/7.ba224a3d.js"><link rel="prefetch" href="/cityseer/assets/js/8.c8d82683.js"><link rel="prefetch" href="/cityseer/assets/js/9.392b743d.js">
    <link rel="stylesheet" href="/cityseer/assets/css/0.styles.7973ef14.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/cityseer/" class="home-link router-link-active"><img src="/cityseer/round_logo.png" alt="Cityseer API Docs" class="logo"> <span class="site-name can-hide">Cityseer API Docs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/cityseer/" class="nav-link">
  home
</a></div><div class="nav-item"><a href="/cityseer/intro.html" class="nav-link">
  docs
</a></div><div class="nav-item"><a href="https://cityseer.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cityseer.io
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/cityseer/cityseer" target="_blank" rel="noopener noreferrer" class="repo-link">
    github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/cityseer/" class="nav-link">
  home
</a></div><div class="nav-item"><a href="/cityseer/intro.html" class="nav-link">
  docs
</a></div><div class="nav-item"><a href="https://cityseer.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  cityseer.io
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/cityseer/cityseer" target="_blank" rel="noopener noreferrer" class="repo-link">
    github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>overview</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/cityseer/intro.html" class="sidebar-link">intro</a></li><li><a href="/cityseer/attribution.html" class="sidebar-link">attribution</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/cityseer/guide/cleaning.html" aria-current="page" class="active sidebar-link">graph cleaning</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/cityseer/guide/cleaning.html#downloading-data" class="sidebar-link">Downloading data</a></li><li class="sidebar-sub-header"><a href="/cityseer/guide/cleaning.html#generating-a-graph" class="sidebar-link">Generating a graph</a></li><li class="sidebar-sub-header"><a href="/cityseer/guide/cleaning.html#deducing-the-network-topology" class="sidebar-link">Deducing the network topology</a></li><li class="sidebar-sub-header"><a href="/cityseer/guide/cleaning.html#refining-the-network" class="sidebar-link">Refining the network</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>cityseer.metrics</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/cityseer/metrics/layers.html" class="sidebar-link">metrics.layers</a></li><li><a href="/cityseer/metrics/networks.html" class="sidebar-link">metrics.networks</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>cityseer.util</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/cityseer/util/graphs.html" class="sidebar-link">util.graphs</a></li><li><a href="/cityseer/util/mock.html" class="sidebar-link">util.mock</a></li><li><a href="/cityseer/util/plot.html" class="sidebar-link">util.plot</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><blockquote><p>A notebook of this guide can be found at <a href="https://colab.research.google.com/github/cityseer/cityseer/blob/master/demo_notebooks/graph_cleaning.ipynb" target="_blank" rel="noopener noreferrer">google colaboratory<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></blockquote> <h1 id="graph-cleaning"><a href="#graph-cleaning" class="header-anchor">#</a> Graph cleaning</h1> <p>Good sources of street network data, such as the Ordnance Survey's <a href="https://www.ordnancesurvey.co.uk/business-and-government/products/os-open-roads.html" target="_blank" rel="noopener noreferrer">OS Open Roads<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, typically have two distinguishing characteristics:</p> <ul><li>The network has been simplified to its essential structure: i.e. unnecessarily complex representations of intersections; on-ramps; split roadways; etc. have been reduced to a simpler representation concurring more readily with the core topological structure of street networks. This is in contrast to network representations focusing on completeness (e.g. for route way-finding, see <a href="https://www.ordnancesurvey.co.uk/business-and-government/help-and-support/products/itn-layer.html" target="_blank" rel="noopener noreferrer">OS ITN Layer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>): these introduce unnecessary complexity serving to hinder rather than help shortest-path algorithms.</li> <li>The topology of the network is kept distinct from the geometry of the streets. Oftentimes, as can be seen with <a href="https://www.openstreetmap.org" target="_blank" rel="noopener noreferrer">Open Street Map<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, additional nodes are added to streets for the purpose of representing geometric twists and turns along a roadway. These additional nodes cause topological distortions that impact network centrality measures.</li></ul> <p>When a high-quality source is available, it may be best not to attempt additional cleanup unless there is a particular reason to do so. On the other-hand, many indispensable sources of network information, particularly Open Street Map data, can be messy for the purposes of network analysis. This section describes how such sources can be cleaned and prepared for subsequent analysis.</p> <h2 id="downloading-data"><a href="#downloading-data" class="header-anchor">#</a> Downloading data</h2> <p>This example will make use of OSM data downloaded from the <a href="https://wiki.openstreetmap.org/wiki/API" target="_blank" rel="noopener noreferrer">OSM API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. To keep things interesting, let's pick Travalgar Square in London, which will be buffered and cleaned for a <mjx-container jax="CHTML" class="MathJax"><mjx-math class=" MJX-TEX"><mjx-mn class="mjx-n"><mjx-c c="1"></mjx-c></mjx-mn><mjx-mo class="mjx-n"><mjx-c c=","></mjx-c></mjx-mo><mjx-mn space="2" class="mjx-n"><mjx-c c="6"></mjx-c><mjx-c c="0"></mjx-c><mjx-c c="0"></mjx-c></mjx-mn><mjx-mi class="mjx-i"><mjx-c c="m"></mjx-c></mjx-mi></mjx-math></mjx-container> radius.</p> <div class="custom-block warning"><p class="custom-block-title">Note</p> <p>The following example makes use of two excellent python modules: <a href="https://github.com/Turbo87/utm" target="_blank" rel="noopener noreferrer"><code>utm</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for converting between <code>WGS</code> geographic coordinates and <code>UTM</code> projected coordinates; and <a href="https://github.com/Toblerity/Shapely" target="_blank" rel="noopener noreferrer"><code>shapely</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for generating and manipulating geometry.</p></div> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> requests
<span class="token keyword">import</span> utm
<span class="token keyword">from</span> shapely <span class="token keyword">import</span> geometry

<span class="token comment"># let's download data within a 1,600m buffer around Travalgar Square in London:</span>
lat<span class="token punctuation">,</span> lng <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">51.507999</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.127970</span><span class="token punctuation">)</span>
<span class="token comment"># cast the WGS coordinates to UTM prior to buffering</span>
easting<span class="token punctuation">,</span> northing<span class="token punctuation">,</span> utm_zone_number<span class="token punctuation">,</span> utm_zone_letter <span class="token operator">=</span> utm<span class="token punctuation">.</span>from_latlon<span class="token punctuation">(</span>lat<span class="token punctuation">,</span> lng<span class="token punctuation">)</span> 
<span class="token comment"># create a point, and then buffer</span>
pt <span class="token operator">=</span> geometry<span class="token punctuation">.</span>Point<span class="token punctuation">(</span>easting<span class="token punctuation">,</span> northing<span class="token punctuation">)</span>
geom_utm <span class="token operator">=</span> pt<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">(</span><span class="token number">1600</span><span class="token punctuation">)</span>
<span class="token comment"># cast the geometry back to WGS for the OSM query</span>
geom_wgs <span class="token operator">=</span> <span class="token punctuation">[</span>utm<span class="token punctuation">.</span>to_latlon<span class="token punctuation">(</span>e<span class="token punctuation">,</span> n<span class="token punctuation">,</span> utm_zone_number<span class="token punctuation">,</span> utm_zone_letter<span class="token punctuation">)</span> <span class="token keyword">for</span> e<span class="token punctuation">,</span> n <span class="token keyword">in</span> geom_utm<span class="token punctuation">.</span>exterior<span class="token punctuation">.</span>coords<span class="token punctuation">]</span>
<span class="token comment"># format for OSM query</span>
geom_osm <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>lat<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>lng<span class="token punctuation">}</span></span><span class="token string">'</span></span> <span class="token keyword">for</span> lat<span class="token punctuation">,</span> lng <span class="token keyword">in</span> geom_wgs<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># osm query</span>
timeout <span class="token operator">=</span> <span class="token number">10</span>
filters <span class="token operator">=</span> <span class="token string">'[&quot;area&quot;!~&quot;yes&quot;]'</span> \
          <span class="token string">'[&quot;highway&quot;!~&quot;path|footway|motor|proposed|construction|abandoned|platform|raceway|service&quot;]'</span> \
          <span class="token string">'[&quot;foot&quot;!~&quot;no&quot;]'</span> \
          <span class="token string">'[&quot;service&quot;!~&quot;private&quot;]'</span> \
          <span class="token string">'[&quot;access&quot;!~&quot;private&quot;]'</span>
query <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'[out:json][timeout:</span><span class="token interpolation"><span class="token punctuation">{</span>timeout<span class="token punctuation">}</span></span><span class="token string">];(way[&quot;highway&quot;]</span><span class="token interpolation"><span class="token punctuation">{</span>filters<span class="token punctuation">}</span></span><span class="token string">(poly:&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>geom_osm<span class="token punctuation">}</span></span><span class="token string">&quot;); &gt;;);out skel qt;'</span></span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://overpass-api.de/api/interpreter'</span><span class="token punctuation">,</span>
                            timeout<span class="token operator">=</span>timeout<span class="token punctuation">,</span>
                            params<span class="token operator">=</span><span class="token punctuation">{</span>
                                <span class="token string">'data'</span><span class="token punctuation">:</span> query
                            <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> requests<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>RequestException <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">raise</span> e
    
<span class="token comment"># NOTE: this code block can be combined with the subsequent blocks for a continuous example.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">Hint</p> <p>You may want to experiment with the filtering applied to the OSM query. See the <a href="https://wiki.openstreetmap.org/wiki/Overpass_API" target="_blank" rel="noopener noreferrer">OSM Overpass API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for more information.</p></div> <h2 id="generating-a-graph"><a href="#generating-a-graph" class="header-anchor">#</a> Generating a graph</h2> <p>Once the data has been downloaded, <code>cityseer.util</code> can be used to load and subsequently clean the network. The graph should be converted from WGS to UTM coordinates prior to further processing.</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> cityseer<span class="token punctuation">.</span>util <span class="token keyword">import</span> graphs<span class="token punctuation">,</span> plot

<span class="token comment"># load the OSM response data into a networkX graph</span>
G_wgs <span class="token operator">=</span> graphs<span class="token punctuation">.</span>nX_from_osm<span class="token punctuation">(</span>osm_json<span class="token operator">=</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
<span class="token comment"># cast the graph to UTM coordinates prior to processing</span>
G_utm <span class="token operator">=</span> graphs<span class="token punctuation">.</span>nX_wgs_to_utm<span class="token punctuation">(</span>G_wgs<span class="token punctuation">)</span>

plot<span class="token punctuation">.</span>plot_nX<span class="token punctuation">(</span>G_utm<span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dpi<span class="token operator">=</span><span class="token number">150</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div><img src="/cityseer/assets/img/graph_raw.1e894d6e.png" alt="Raw OSM graph"> <em> The raw OSM graph after conversion to UTM coordinates. © OpenStreetMap contributors. </em> <!----></div> <h2 id="deducing-the-network-topology"><a href="#deducing-the-network-topology" class="header-anchor">#</a> Deducing the network topology</h2> <p>Now that raw OSM data has been loaded into a NetworkX graph, the <code>cityseer.util.graph</code> methods can be used to further clean and prepare the network prior to analysis.</p> <p>At this stage, the raw OSM graph is going to look a bit messy. Note how that nodes have been used to represent the roadway geometry. These nodes need to be removed and will be abstracted into <code>shapely</code> <code>LineString</code> geometries assigned to the respective street edges. So doing, the geometric representation will be kept distinct from the network topology.</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># the raw osm nodes denote the road geometries by the placement of nodes</span>
<span class="token comment"># the first step will generate explicit linestring geometries for each street edge</span>
G <span class="token operator">=</span> graphs<span class="token punctuation">.</span>nX_simple_geoms<span class="token punctuation">(</span>G_utm<span class="token punctuation">)</span>
<span class="token comment"># OSM graphs will often have &quot;stubs&quot;, e.g. at entrances to buildings or parking lots</span>
<span class="token comment"># these will now be removed, and can be fine-tuned with the despine parameter.</span>
<span class="token comment"># The removed_disconnected flag will removed isolated network components</span>
<span class="token comment"># i.e. disconnected portions of network that are not joined to the main street network</span>
G <span class="token operator">=</span> graphs<span class="token punctuation">.</span>nX_remove_dangling_nodes<span class="token punctuation">(</span>G<span class="token punctuation">,</span> despine<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">,</span> remove_disconnected<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment"># strip the &quot;filler-nodes&quot; from the graph</span>
<span class="token comment"># the associated geometries will be welded into continuous linestrings</span>
<span class="token comment"># the new linestrings will be assigned to the newly consolidated topological links</span>
G <span class="token operator">=</span> graphs<span class="token punctuation">.</span>nX_remove_filler_nodes<span class="token punctuation">(</span>G<span class="token punctuation">)</span>

plot<span class="token punctuation">.</span>plot_nX<span class="token punctuation">(</span>G<span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dpi<span class="token operator">=</span><span class="token number">150</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div><img src="/cityseer/assets/img/graph_topo.e148e0f2.png" alt="OSM graph topology"> <em> The OSM graph after conversion to a topological representation. © OpenStreetMap contributors. </em> <!----></div> <div class="custom-block warning"><p class="custom-block-title">Note</p> <p>At this point it may initially appear that the roadway geometries have now gone missing. However, this information is still present in the <code>LineString</code> geometries assigned to each street edge. Put differently, the plotted representation is now topological, not geometric. During conversion to a <code>cityseer</code> network map, <code>cityseer</code> will automatically compute the length and comulative angular change for each of these <code>LineString</code> geoms. The entry and exit angle of each network edge is also determined and is used internally to compute and aggregate angular change from one street to another.</p></div> <h2 id="refining-the-network"><a href="#refining-the-network" class="header-anchor">#</a> Refining the network</h2> <p>The final step involves the consolidation of nodes to clean-up extraneous nodes, which may otherwise exaggerate the intensity or complexity of the network in certain situations.</p> <p>Two different methods can be used for this purpose:</p> <ul><li><a href="https://cityseer.github.io/cityseer/util/graphs.html#nx-consolidate-spatial" target="_blank" rel="noopener noreferrer"><code>X_consolidate_spatial</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> consolidates adjacent nodes based on a crow-flies distance threshold;</li> <li><a href="https://cityseer.github.io/cityseer/util/graphs.html#nx-consolidate-parallel" target="_blank" rel="noopener noreferrer">nX_consolidate_parallel<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> consolidates adjacent nodes for parallel edges, and tends to give superior results.
Both methods take a <code>buffer_dist</code> parameter specifying the threshold distance at which to apply consolidation, and may involve a degree of experimentation to find suitable distance.</li></ul> <p>These methods can optionally be combined with network decomposition, which can be applied before or after, depending on which gives the best results for a given situation.</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># decomposition of the network will even out the intensity of nodes</span>
<span class="token comment"># set the decompose_max flag based on the level of granularity required</span>
G <span class="token operator">=</span> graphs<span class="token punctuation">.</span>nX_decompose<span class="token punctuation">(</span>G<span class="token punctuation">,</span> decompose_max<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span>
<span class="token comment"># simplify split roadways</span>
<span class="token comment"># some experimentation may be required to find the optimal buffer distance</span>
<span class="token comment"># setting it too large, will deteriorate the quality of the network</span>
G <span class="token operator">=</span> graphs<span class="token punctuation">.</span>nX_consolidate_parallel<span class="token punctuation">(</span>G<span class="token punctuation">,</span> buffer_dist<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span>

plot<span class="token punctuation">.</span>plot_nX<span class="token punctuation">(</span>G<span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dpi<span class="token operator">=</span><span class="token number">150</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div><img src="/cityseer/assets/img/graph_consolidated.cda52d4c.png" alt="OSM graph after decomposition and consolidation"> <em> The OSM graph after decomposition and consolidation. © OpenStreetMap contributors. </em> <!----></div> <p>There may still be locations that need some manual cleaning, though this is now much easier to accomplish. The graph is now ready for analysis with the <code>cityseer</code> package's methods.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/12/2020, 10:20:53 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/cityseer/attribution.html" class="prev">
        attribution
      </a></span> <span class="next"><a href="/cityseer/metrics/layers.html">
        metrics.layers
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/cityseer/assets/js/app.9d063ece.js" defer></script><script src="/cityseer/assets/js/2.0e550b61.js" defer></script><script src="/cityseer/assets/js/6.5f7a5e8e.js" defer></script><script src="/cityseer/assets/js/13.4af07594.js" defer></script>
  </body>
</html>
